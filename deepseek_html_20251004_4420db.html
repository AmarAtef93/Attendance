<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Staff Attendance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .login-section {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            margin: 40px auto;
        }
        .view-section {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        h1, h2, h3 {
            color: #333;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #4a5568;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4a5568;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            cursor: pointer;
            margin: 8px 0;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-success {
            background: #48bb78;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .btn-danger {
            background: #f56565;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        .btn-warning:hover {
            background: #dd6b20;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #4a5568;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f7fafc;
        }
        tr:hover {
            background-color: #edf2f7;
        }
        .user-info {
            background: linear-gradient(135deg, #edf2f7, #e2e8f0);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #4299e1;
        }
        .nav {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .nav button {
            width: auto;
            padding: 12px 24px;
            border-radius: 25px;
        }
        .current-user {
            background: #4299e1;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .logout-btn {
            width: auto;
            padding: 10px 20px;
            background: #f56565;
            border-radius: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid #4299e1;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 8px;
        }
        .setup-section {
            background: #fffaf0;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            border: 2px dashed #ed8936;
        }
        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status-success {
            background: #f0fff4;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }
        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #feb2b2;
        }
        .status-info {
            background: #ebf8ff;
            color: #1a365d;
            border: 2px solid #90cdf4;
        }
        .user-list {
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        .connection-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .connected {
            background: #c6f6d5;
            color: #22543d;
        }
        .disconnected {
            background: #fed7d7;
            color: #742a2a;
        }
        .instructions {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4299e1;
        }
        .instructions ol {
            margin-left: 25px;
        }
        .instructions li {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        .punch-section {
            text-align: center;
            padding: 40px 20px;
        }
        .punch-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        .punch-btn {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }
        .status-indicator {
            font-size: 24px;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            max-width: 400px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .nav {
                flex-direction: column;
            }
            .nav button {
                width: 100%;
            }
            .punch-buttons {
                flex-direction: column;
                align-items: center;
            }
            .punch-btn {
                width: 150px;
                height: 150px;
            }
            table {
                font-size: 14px;
            }
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h1>üè¢ Online Staff Attendance System</h1>
            <p style="text-align: center; margin-bottom: 30px; color: #718096;">Real-time cloud-based attendance tracking</p>
            
            <div class="setup-section" id="setupSection">
                <h3 style="color: #ed8936; margin-bottom: 15px;">üìã First Time Setup Required</h3>
                <div class="instructions">
                    <ol>
                        <li><strong>Create Google Sheet</strong> with headers: Date, EmployeeID, EmployeeName, TimeIn, TimeOut, Status</li>
                        <li><strong>Create Apps Script</strong> (Extensions ‚Üí Apps Script)</li>
                        <li><strong>Paste the script</strong> (click "Setup Guide" after login)</li>
                        <li><strong>Deploy as web app</strong> with "Anyone" access</li>
                        <li><strong>Copy URL</strong> and paste below</li>
                    </ol>
                </div>
            </div>

            <div class="form-group">
                <label for="sheetUrl">üîó Google Sheets API URL:</label>
                <input type="text" id="sheetUrl" placeholder="https://script.google.com/macros/s/...">
                <small style="color: #718096; display: block; margin-top: 5px;">Paste your deployed Google Apps Script URL here</small>
            </div>

            <div class="form-group">
                <label for="username">üë§ Username:</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="password">üîí Password:</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <div class="form-group">
                <label for="userType">üéØ Login As:</label>
                <select id="userType">
                    <option value="staff">Staff Member</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            <button onclick="login()" style="background: linear-gradient(135deg, #4299e1, #667eea);">üöÄ Login to System</button>
            
            <div style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                <h4 style="margin-bottom: 15px; color: #4a5568;">üë• Demo Accounts:</h4>
                <p><strong>Admin:</strong> admin / admin123</p>
                <p><strong>Staff:</strong> ahmedezz / ahmed123</p>
                <p><strong>Staff:</strong> mohamedali / ali123</p>
            </div>
        </div>

        <!-- Staff View -->
        <div id="staffView" class="view-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                <h1 style="margin: 0;">üë§ Staff Attendance Portal</h1>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <span class="current-user" id="staffUserName">Staff User</span>
                    <span class="connection-status" id="staffConnectionStatus">Disconnected</span>
                    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
                </div>
            </div>

            <div class="user-info">
                <h3 style="margin-bottom: 10px;">Welcome, <span id="staffName">Staff Member</span>! üëã</h3>
                <p>üÜî Employee ID: <strong><span id="staffId">EMP001</span></strong></p>
                <p>üìÖ Today's Date: <strong><span id="currentDate"></span></strong></p>
                <p>üåê Connection: <span id="sheetStatus">Disconnected</span></p>
            </div>

            <div class="nav">
                <button onclick="showStaffSection('punch')">‚è∞ Punch In/Out</button>
                <button onclick="showStaffSection('myRecords')">üìä My Records</button>
                <button onclick="testConnection()" class="btn-warning">üîó Test Connection</button>
            </div>

            <!-- Punch Section -->
            <div id="staffPunchSection">
                <h2>‚è∞ Time Attendance</h2>
                <div class="punch-section">
                    <div class="status-indicator" id="currentStatus" style="background: #fed7d7; color: #742a2a;">
                        Not Checked In
                    </div>
                    <div class="punch-buttons">
                        <button class="punch-btn btn-success" onclick="punchIn()">
                            <span style="font-size: 24px;">‚úÖ</span>
                            Punch In
                        </button>
                        <button class="punch-btn btn-danger" onclick="punchOut()">
                            <span style="font-size: 24px;">‚ùå</span>
                            Punch Out
                        </button>
                    </div>
                </div>
                <div id="punchMessage"></div>
            </div>

            <!-- My Records Section -->
            <div id="staffRecordsSection" style="display: none;">
                <h2>üìä My Attendance History</h2>
                <button onclick="loadStaffRecords()" style="width: auto; margin-bottom: 20px;">üîÑ Refresh Data</button>
                <div id="staffRecordsMessage"></div>
                <table id="staffRecordsTable">
                    <thead>
                        <tr>
                            <th>üìÖ Date</th>
                            <th>‚¨ÜÔ∏è Time In</th>
                            <th>‚¨áÔ∏è Time Out</th>
                            <th>üìù Status</th>
                            <th>‚è±Ô∏è Hours Worked</th>
                        </tr>
                    </thead>
                    <tbody id="staffRecordsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="view-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                <h1 style="margin: 0;">üë®‚Äçüíº Admin Attendance Portal</h1>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <span class="current-user">Administrator</span>
                    <span class="connection-status" id="adminConnectionStatus">Disconnected</span>
                    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
                </div>
            </div>

            <div class="user-info">
                <p style="margin: 0 0 15px 0;">üåê Sheet Status: <span id="adminSheetStatus">Disconnected</span></p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button onclick="testConnection()" style="width: auto;">üîó Test Connection</button>
                    <button onclick="loadAllData()" style="width: auto;">üîÑ Refresh All Data</button>
                </div>
            </div>

            <div class="nav">
                <button onclick="showAdminSection('dashboard')">üìà Dashboard</button>
                <button onclick="showAdminSection('manage')">üë• Manage Records</button>
                <button onclick="showAdminSection('users')">üë§ Manage Users</button>
                <button onclick="showAdminSection('reports')">üìã Reports</button>
                <button onclick="showAdminSection('setup')">‚öôÔ∏è Setup Guide</button>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboardSection">
                <h2>üìà Attendance Dashboard</h2>
                <button onclick="loadAdminData()" style="width: auto; margin-bottom: 20px;">üîÑ Refresh Dashboard</button>
                <div id="dashboardMessage"></div>
                <div class="stats" id="adminStats">
                    <!-- Stats will be loaded here -->
                </div>
                
                <h3 style="margin-top: 30px;">üìä Today's Attendance</h3>
                <div id="todayAttendance"></div>
            </div>

            <!-- Manage Records -->
            <div id="adminManageSection" style="display: none;">
                <h2>üë• All Attendance Records</h2>
                <div style="margin: 20px 0; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button onclick="loadAllRecords()" style="width: auto;">üîÑ Refresh Records</button>
                    <button class="btn-success" onclick="exportToExcel()" style="width: auto;">üì• Export to Excel</button>
                    <button class="btn-warning" onclick="showAddRecordForm()" style="width: auto;">‚ûï Add Manual Record</button>
                </div>
                <div id="manageMessage"></div>
                <table id="adminRecordsTable">
                    <thead>
                        <tr>
                            <th>üìÖ Date</th>
                            <th>üÜî Employee ID</th>
                            <th>üë§ Name</th>
                            <th>‚¨ÜÔ∏è Time In</th>
                            <th>‚¨áÔ∏è Time Out</th>
                            <th>üìù Status</th>
                            <th>‚è±Ô∏è Hours</th>
                            <th>‚öôÔ∏è Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminRecordsBody">
                    </tbody>
                </table>
            </div>

            <!-- Manage Users -->
            <div id="adminUsersSection" style="display: none;">
                <h2>üë§ Staff Management</h2>
                <div style="margin: 20px 0; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-success" onclick="exportUsersToExcel()" style="width: auto;">üì• Export Users List</button>
                    <button class="btn-warning" onclick="showUserCredentials()" style="width: auto;">üîë Show All Credentials</button>
                </div>
                <div class="user-list">
                    <table>
                        <thead>
                            <tr>
                                <th>üë§ Username</th>
                                <th>üìõ Full Name</th>
                                <th>üÜî Employee ID</th>
                                <th>üéØ User Type</th>
                                <th>üîë Password</th>
                                <th>‚öôÔ∏è Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersListBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="adminReportsSection" style="display: none;">
                <h2>üìã Generate Reports</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div class="form-group">
                        <label for="reportDate">üìÖ Select Date:</label>
                        <input type="date" id="reportDate">
                    </div>
                    <div class="form-group">
                        <label for="reportEmployee">üë§ Select Employee:</label>
                        <select id="reportEmployee">
                            <option value="all">All Employees</option>
                        </select>
                    </div>
                </div>
                <button class="btn-success" onclick="generateReport()" style="width: auto;">üìä Generate Report</button>
                <div id="reportResults" style="margin-top: 20px;"></div>
            </div>

            <!-- Setup Guide -->
            <div id="adminSetupSection" style="display: none;">
                <h2>‚öôÔ∏è Google Sheets Setup Guide</h2>
                
                <div class="setup-section">
                    <h3 style="color: #4299e1; margin-bottom: 15px;">üéØ Current Configuration</h3>
                    <div class="form-group">
                        <label for="currentSheetUrl">Your Google Sheets API URL:</label>
                        <input type="text" id="currentSheetUrl" style="background: #f7fafc;" readonly>
                    </div>
                </div>

                <div class="instructions">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">üìù Step-by-Step Setup</h3>
                    
                    <h4 style="color: #2d3748; margin-bottom: 15px;">1. üìä Create Google Sheet</h4>
                    <p style="margin-bottom: 15px;">Create a new Google Sheet with these exact headers in the first row:</p>
                    <table style="background: white; margin: 15px 0; border-radius: 8px; overflow: hidden;">
                        <tr style="background: #4299e1; color: white;">
                            <th style="padding: 12px;">A1: Date</th>
                            <th style="padding: 12px;">B1: EmployeeID</th>
                            <th style="padding: 12px;">C1: EmployeeName</th>
                            <th style="padding: 12px;">D1: TimeIn</th>
                            <th style="padding: 12px;">E1: TimeOut</th>
                            <th style="padding: 12px;">F1: Status</th>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #e2e8f0;">2024-01-15</td>
                            <td style="padding: 10px; border: 1px solid #e2e8f0;">EMP001</td>
                            <td style="padding: 10px; border: 1px solid #e2e8f0;">John Doe</td>
                            <td style="padding: 10px; border: 1px solid #e2e8f0;">09:00</td>
                            <td style="padding: 10px; border: 1px solid #e2e8f0;">17:00</td>
                            <td style="padding: 10px; border: 1px solid #e2e8f0;">Present</td>
                        </tr>
                    </table>

                    <h4 style="color: #2d3748; margin: 25px 0 15px 0;">2. üîß Create Apps Script</h4>
                    <p style="margin-bottom: 15px;">Click <strong>Extensions ‚Üí Apps Script</strong> and replace any code with this:</p>
                    <textarea id="scriptCode" rows="25" style="width: 100%; font-family: 'Courier New', monospace; font-size: 12px; background: #2d3748; color: #e2e8f0; border: 2px solid #4a5568; border-radius: 8px; padding: 15px;" readonly>
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'addRecord') {
      sheet.appendRow([
        data.record.date,
        data.record.employeeId,
        data.record.employeeName,
        data.record.timeIn,
        data.record.timeOut,
        data.record.status
      ]);
      return ContentService.createTextOutput(JSON.stringify({
        success: true, 
        message: 'Record added successfully'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    else if (data.action === 'getRecords') {
      const records = sheet.getDataRange().getValues();
      if (records.length <= 1) {
        return ContentService.createTextOutput(JSON.stringify({
          success: true, 
          data: []
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      const headers = records[0];
      const result = [];
      
      for (let i = 1; i < records.length; i++) {
        const obj = {};
        for (let j = 0; j < headers.length; j++) {
          obj[headers[j]] = records[i][j];
        }
        result.push(obj);
      }
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true, 
        data: result
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false, 
      error: 'Invalid action'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false, 
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    message: "Attendance System API is running",
    timestamp: new Date().toISOString()
  })).setMimeType(ContentService.MimeType.JSON);
}
                    </textarea>
                    <button onclick="copyScript()" style="width: auto; margin-top: 15px;">üìã Copy Script to Clipboard</button>

                    <h4 style="color: #2d3748; margin: 25px 0 15px 0;">3. üöÄ Deploy as Web App</h4>
                    <ul style="background: white; padding: 20px; border-radius: 8px;">
                        <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                        <li>Select type: <strong>Web app</strong></li>
                        <li>Execute as: <strong>Me</strong></li>
                        <li>Who has access: <strong>Anyone</strong></li>
                        <li>Click <strong>Deploy</strong></li>
                        <li>Copy the Web App URL</li>
                    </ul>

                    <h4 style="color: #2d3748; margin: 25px 0 15px 0;">4. üîó Connect to System</h4>
                    <p>Paste the copied URL in the login form and start using the system!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Complete user database with all 48 staff members
        const users = {
            // Admin account
            'admin': { 
                password: 'admin123', 
                name: 'System Administrator', 
                id: 'ADMIN001', 
                type: 'admin',
                fullName: 'System Administrator'
            },

            // Staff accounts
            'abdelradysalah': { password: 'abdelrady123', name: 'Abd El-Rady Salah', id: 'EMP001', type: 'staff', fullName: 'Abd El-Rady Salah Abd El-Rady Abd El-Rahman' },
            'abdelrahmanaly': { password: 'abdelrahman123', name: 'Abd El-Rahman ElSayed', id: 'EMP002', type: 'staff', fullName: 'Abd El-Rahman ElSayed Mohamed Aly' },
            'abdelrahmanfawzy': { password: 'fawzy123', name: 'Abd El-Rahman Fawzy', id: 'EMP003', type: 'staff', fullName: 'Abd El-Rahman Fawzy Abdallah El-Mandoura' },
            'abdelrahmanawad': { password: 'awad123', name: 'Abd El-Rahman Mohamed', id: 'EMP004', type: 'staff', fullName: 'Abd El-Rahman Mohamed Awad Allah' },
            'adelmagdy': { password: 'adel123', name: 'Adel Magdy', id: 'EMP005', type: 'staff', fullName: 'Adel Magdy Adel Ahmed' },
            'ahmedezz': { password: 'ahmed123', name: 'Ahmed Ezz', id: 'EMP006', type: 'staff', fullName: 'Ahmed Ezz El-Sayed' },
            'ahmedgaber': { password: 'gaber123', name: 'Ahmed Gaber', id: 'EMP007', type: 'staff', fullName: 'Ahmed Gaber Mohamed Mohamed Soliman' },
            'ahmedhamed': { password: 'hamed123', name: 'Ahmed Hamed', id: 'EMP008', type: 'staff', fullName: 'Ahmed Hamed Desouky Hassanin' },
            'ahmedramadan': { password: 'ramadan123', name: 'Ahmed Ramadan', id: 'EMP009', type: 'staff', fullName: 'Ahmed Ramadan Mohamed Abd El-Hady' },
            'ahmedyassen': { password: 'yassen123', name: 'Ahmed Yassen', id: 'EMP010', type: 'staff', fullName: 'Ahmed Yassen Abd El-Bakey Ahmed' },
            'aliessam': { password: 'ali123', name: 'Ali Essam', id: 'EMP011', type: 'staff', fullName: 'Ali Essam Ali Hamouda' },
            'amalmohamed': { password: 'amal123', name: 'Amal Mohamed', id: 'EMP012', type: 'staff', fullName: 'Amal Mohamed Zaki Rashwan' },
            'amiraahmed': { password: 'amira123', name: 'Amira Ahmed', id: 'EMP013', type: 'staff', fullName: 'Amira Ahmed Hussien Hassan' },
            'eslamreda': { password: 'eslam123', name: 'Eslam Reda', id: 'EMP014', type: 'staff', fullName: 'Eslam Reda Yaqokt' },
            'fatmashalby': { password: 'fatma123', name: 'Fatma Shalby', id: 'EMP015', type: 'staff', fullName: 'Fatma Shalby Ahmed Mahmoud' },
            'hagarl': { password: 'hagar123', name: 'Hagar Haddad', id: 'EMP016', type: 'staff', fullName: 'Hagar Haddad Ramadan Al-Sayed' },
            'hagershaban': { password: 'hager123', name: 'Hager Shaban', id: 'EMP017', type: 'staff', fullName: 'Hager Shaban Beltagy AbdElRahim' },
            'hebasaied': { password: 'heba123', name: 'Heba Saied', id: 'EMP018', type: 'staff', fullName: 'Heba Saied Atia Mansour' },
            'ibrahimmohamed': { password: 'ibrahim123', name: 'Ibrahim Mohamed', id: 'EMP019', type: 'staff', fullName: 'Ibrahim Mohamed Ibrahim' },
            'mahmoudabdellatief': { password: 'mahmoud123', name: 'Mahmoud AbdEl-Latief', id: 'EMP020', type: 'staff', fullName: 'Mahmoud AbdEl-Latief Atiaa' },
            'mahmoudharby': { password: 'harby123', name: 'Mahmoud Harby', id: 'EMP021', type: 'staff', fullName: 'Mahmoud Harby Anwar Omran Bekhit' },
            'mahrousismail': { password: 'mahrous123', name: 'Mahrous Ismail', id: 'EMP022', type: 'staff', fullName: 'Mahrous Isamail Mohamed' },
            'marwaabdelhakem': { password: 'marwa123', name: 'Marwa Abd El-Hakem', id: 'EMP023', type: 'staff', fullName: 'Marwa Abd El-Hakem Ahmed Mohamed Saad' },
            'mayarshokry': { password: 'mayar123', name: 'Mayar Shokry', id: 'EMP024', type: 'staff', fullName: 'Mayar Shokry Ahmed Ahmed' },
            'mohabalaa': { password: 'mohab123', name: 'Mohab Alaa', id: 'EMP025', type: 'staff', fullName: 'Mohab Alaa El-Din Shehata Mohamed' },
            'mohamedabdelsalam': { password: 'mohamed123', name: 'Mohamed Abd ElSalam', id: 'EMP026', type: 'staff', fullName: 'Mohamed Abd ElSalam Darwish ElBehiry' },
            'mohamedalii': { password: 'ali123', name: 'Mohamed Ali', id: 'EMP027', type: 'staff', fullName: 'Mohamed Ali Mohamed sabah' },
            'mohamedhashem': { password: 'hashem123', name: 'Mohamed Hashem', id: 'EMP028', type: 'staff', fullName: 'Mohamed Hashem Abd El Fatah' },
            'mohamedibrahim': { password: 'ibrahim123', name: 'Mohamed Ibrahim', id: 'EMP029', type: 'staff', fullName: 'Mohamed Ibrahim Mohamed Ali' },
            'mohamedseliem': { password: 'seliem123', name: 'Mohamed Seliem', id: 'EMP030', type: 'staff', fullName: 'Mohamed Mohamed Seliem Abd El-Kawy' },
            'mohamedramadans': { password: 'ramadan123', name: 'Mohamed Ramadan', id: 'EMP031', type: 'staff', fullName: 'Mohamed Ramadan Saad Khamis' },
            'mohamedsaber': { password: 'saber123', name: 'Mohamed Saber', id: 'EMP032', type: 'staff', fullName: 'Mohamed Saber Abd El-Fatah El-Soudy' },
            'mohamedsabry': { password: 'sabry123', name: 'Mohamed Sabry', id: 'EMP033', type: 'staff', fullName: 'Mohamed Sabry Mohamed AbdElKarem' },
            'mostafayasser': { password: 'mostafa123', name: 'Mostafa Yasser', id: 'EMP034', type: 'staff', fullName: 'Mostafa Yasser Ramadan Faragly' },
            'moustafayathreb': { password: 'moustafa123', name: 'Moustafa Yathreb', id: 'EMP035', type: 'staff', fullName: 'Moustafa Yathreb ElSayed Ibrahim' },
            'nadamohamed': { password: 'nada123', name: 'Nada Mohamed', id: 'EMP036', type: 'staff', fullName: 'Nada Mohamed El-Sayed Mohamed' },
            'nassermohamed': { password: 'nasser123', name: 'Nasser Mohamed', id: 'EMP037', type: 'staff', fullName: 'Nasser Mohamed Mahmoud Bakr' },
            'nourhanelshat': { password: 'nourhan123', name: 'Nourhan El-Shat', id: 'EMP038', type: 'staff', fullName: 'Nourhan El-Shahat Mohamed Ibrahim' },
            'omarmohamed': { password: 'omar123', name: 'Omar Mohamed', id: 'EMP039', type: 'staff', fullName: 'Omar Mohamed Zakaria Ahmed' },
            'roukiaahmed': { password: 'roukia123', name: 'Roukia Ahmed', id: 'EMP040', type: 'staff', fullName: 'Roukia Ahmed Mahmoud Awwad' },
            'shroukmohamed': { password: 'shrouk123', name: 'Shrouk Mohamed', id: 'EMP041', type: 'staff', fullName: 'Shrouk Mohamed ElSayed Mohamed' },
            'zeyadabdelrauf': { password: 'zeyad123', name: 'Zeyad Abd El-Rauf', id: 'EMP042', type: 'staff', fullName: 'Zeyad Abd El-Rauf Ismail El-Shorbagy' },
            'zeyadafathy': { password: 'zeyad123', name: 'Zeyad Ahmed', id: 'EMP043', type: 'staff', fullName: 'Zeyad Ahmed Fathy Sedik' },
            'zeynabhossam': { password: 'zeynab123', name: 'Zeynab Hossam', id: 'EMP044', type: 'staff', fullName: 'Zeynab Hossam ElDin Mohamed Yakoot' },
            'nourhanabdelmagied': { password: 'nourhan123', name: 'Nourhan Abd El-Magied', id: 'EMP045', type: 'staff', fullName: 'Nourhan Abd El-Magied Hemida Mohamed Ahmed' },
            'ahmedzaki': { password: 'zaki123', name: 'Ahmed Zaki', id: 'EMP046', type: 'staff', fullName: 'Ahmed Zaki Mohamed Zaki' },
            'ahmedtarek': { password: 'tarek123', name: 'Ahmed Tarek', id: 'EMP047', type: 'staff', fullName: 'Ahmed Tarek' },
            'abdelrahmanahmed': { password: 'rahman123', name: 'Abd El-Rahman Ahmed', id: 'EMP048', type: 'staff', fullName: 'Abd El-Rahman Ahmed' }
        };

        let currentUser = null;
        let sheetUrl = '';
        let allRecords = [];

        // Google Sheets API functions
        async function callSheetAPI(action, data = {}) {
            try {
                const payload = {
                    action: action,
                    ...data
                };

                const response = await fetch(sheetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Error:', error);
                return { 
                    success: false, 
                    error: 'Connection failed. Check your URL and internet connection.' 
                };
            }
        }

        async function testConnection() {
            const isStaff = currentUser && currentUser.type === 'staff';
            showMessage('Testing connection to Google Sheets...', isStaff ? 'punchMessage' : 'dashboardMessage', 'info');
            
            const result = await callSheetAPI('getRecords');
            
            if (result.success) {
                showMessage('‚úÖ Successfully connected to Google Sheets!', isStaff ? 'punchMessage' : 'dashboardMessage', 'success');
                updateConnectionStatus('connected');
                return true;
            } else {
                showMessage('‚ùå Connection failed: ' + (result.error || 'Unknown error'), isStaff ? 'punchMessage' : 'dashboardMessage', 'error');
                updateConnectionStatus('disconnected');
                return false;
            }
        }

        function updateConnectionStatus(status) {
            const staffStatus = document.getElementById('staffConnectionStatus');
            const adminStatus = document.getElementById('adminConnectionStatus');
            const sheetStatus = document.getElementById('sheetStatus');
            const adminSheetStatus = document.getElementById('adminSheetStatus');
            
            if (status === 'connected') {
                [staffStatus, adminStatus, sheetStatus, adminSheetStatus].forEach(el => {
                    if (el) {
                        el.textContent = 'Connected';
                        el.className = 'connection-status connected';
                    }
                });
            } else {
                [staffStatus, adminStatus, sheetStatus, adminSheetStatus].forEach(el => {
                    if (el) {
                        el.textContent = 'Disconnected';
                        el.className = 'connection-status disconnected';
                    }
                });
            }
        }

        // Staff Functions
        async function punchIn() {
            const today = new Date().toISOString().split('T')[0];
            const record = {
                date: today,
                employeeId: currentUser.id,
                employeeName: currentUser.name,
                timeIn: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                timeOut: '',
                status: 'Present'
            };

            showMessage('Recording punch in...', 'punchMessage', 'info');
            const result = await callSheetAPI('addRecord', { record });
            
            if (result.success) {
                showMessage('‚úÖ Successfully punched in at ' + record.timeIn, 'punchMessage', 'success');
                updatePunchStatus();
                loadStaffRecords();
            } else {
                showMessage('‚ùå Failed to punch in: ' + (result.error || 'Unknown error'), 'punchMessage', 'error');
            }
        }

        async function punchOut() {
            const today = new Date().toISOString().split('T')[0];
            const record = {
                date: today,
                employeeId: currentUser.id,
                employeeName: currentUser.name,
                timeIn: '',
                timeOut: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                status: 'Present'
            };

            showMessage('Recording punch out...', 'punchMessage', 'info');
            const result = await callSheetAPI('addRecord', { record });
            
            if (result.success) {
                showMessage('‚úÖ Successfully punched out at ' + record.timeOut, 'punchMessage', 'success');
                updatePunchStatus();
                loadStaffRecords();
            } else {
                showMessage('‚ùå Failed to punch out: ' + (result.error || 'Unknown error'), 'punchMessage', 'error');
            }
        }

        async function loadStaffRecords() {
            showMessage('Loading your attendance records...', 'staffRecordsMessage', 'info');
            const result = await callSheetAPI('getRecords');
            
            if (result.success) {
                const staffRecords = result.data.filter(record => record.EmployeeID === currentUser.id);
                displayStaffRecords(staffRecords);
                showMessage(`‚úÖ Loaded ${staffRecords.length} attendance records`, 'staffRecordsMessage', 'success');
            } else {
                showMessage('‚ùå Error loading records: ' + result.error, 'staffRecordsMessage', 'error');
            }
        }

        function displayStaffRecords(records) {
            const tbody = document.getElementById('staffRecordsBody');
            tbody.innerHTML = '';

            // Sort records by date (newest first)
            records.sort((a, b) => new Date(b.Date) - new Date(a.Date));

            records.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.Date}</td>
                    <td>${record.TimeIn || '-'}</td>
                    <td>${record.TimeOut || '-'}</td>
                    <td>${record.Status}</td>
                    <td>${calculateHours(record.TimeIn, record.TimeOut)}</td>
                `;
            });
        }

        // Admin Functions
        async function loadAdminData() {
            showMessage('Loading dashboard data...', 'dashboardMessage', 'info');
            const result = await callSheetAPI('getRecords');
            
            if (result.success) {
                allRecords = result.data;
                displayAdminStats(allRecords);
                displayTodayAttendance(allRecords);
                showMessage('‚úÖ Dashboard data loaded successfully', 'dashboardMessage', 'success');
            } else {
                showMessage('‚ùå Error loading data: ' + result.error, 'dashboardMessage', 'error');
            }
        }

        async function loadAllRecords() {
            showMessage('Loading all attendance records...', 'manageMessage', 'info');
            const result = await callSheetAPI('getRecords');
            
            if (result.success) {
                allRecords = result.data;
                displayAllRecords(allRecords);
                showMessage(`‚úÖ Loaded ${allRecords.length} attendance records`, 'manageMessage', 'success');
            } else {
                showMessage('‚ùå Error loading records: ' + result.error, 'manageMessage', 'error');
            }
        }

        function displayAdminStats(records) {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(record => record.Date === today);
            const staffUsers = Object.values(users).filter(user => user.type === 'staff');
            
            const presentToday = todayRecords.filter(record => record.TimeIn).length;
            const absentToday = staffUsers.length - presentToday;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-number">${staffUsers.length}</div>
                    <div>Total Employees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${presentToday}</div>
                    <div>Present Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${absentToday}</div>
                    <div>Absent Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${records.length}</div>
                    <div>Total Records</div>
                </div>
            `;

            document.getElementById('adminStats').innerHTML = statsHTML;
        }

        function displayTodayAttendance(records) {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(record => record.Date === today);
            const staffUsers = Object.values(users).filter(user => user.type === 'staff');
            
            let html = '<table><thead><tr><th>Employee</th><th>Time In</th><th>Time Out</th><th>Status</th></tr></thead><tbody>';
            
            staffUsers.forEach(user => {
                const userRecord = todayRecords.find(record => record.EmployeeID === user.id);
                if (userRecord) {
                    html += `<tr>
                        <td>${user.name}</td>
                        <td>${userRecord.TimeIn || '-'}</td>
                        <td>${userRecord.TimeOut || '-'}</td>
                        <td>${userRecord.Status || 'Present'}</td>
                    </tr>`;
                } else {
                    html += `<tr style="background: #fed7d7;">
                        <td>${user.name}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>Absent</td>
                    </tr>`;
                }
            });
            
            html += '</tbody></table>';
            document.getElementById('todayAttendance').innerHTML = html;
        }

        function displayAllRecords(records) {
            const tbody = document.getElementById('adminRecordsBody');
            tbody.innerHTML = '';

            // Sort records by date (newest first)
            records.sort((a, b) => new Date(b.Date) - new Date(a.Date));

            records.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.Date}</td>
                    <td>${record.EmployeeID}</td>
                    <td>${record.EmployeeName}</td>
                    <td>${record.TimeIn || '-'}</td>
                    <td>${record.TimeOut || '-'}</td>
                    <td>${record.Status}</td>
                    <td>${calculateHours(record.TimeIn, record.TimeOut)}</td>
                    <td>
                        <button class="btn-danger" onclick="deleteRecord('${record.Date}', '${record.EmployeeID}')">Delete</button>
                    </td>
                `;
            });
        }

        function loadUsersList() {
            const tbody = document.getElementById('usersListBody');
            tbody.innerHTML = '';

            Object.entries(users).forEach(([username, user]) => {
                if (user.type === 'staff') {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${username}</td>
                        <td>${user.fullName}</td>
                        <td>${user.id}</td>
                        <td>${user.type}</td>
                        <td>${user.password}</td>
                        <td>
                            <button class="btn-warning" onclick="resetPassword('${username}')">Reset Password</button>
                        </td>
                    `;
                }
            });
        }

        function showUserCredentials() {
            let credentials = "üìã Staff Login Credentials:\n\n";
            Object.entries(users).forEach(([username, user]) => {
                if (user.type === 'staff') {
                    credentials += `üë§ ${user.fullName}\n`;
                    credentials += `   Username: ${username}\n`;
                    credentials += `   Password: ${user.password}\n`;
                    credentials += `   Employee ID: ${user.id}\n\n`;
                }
            });
            alert(credentials);
        }

        // UI Functions
        function login() {
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;
            sheetUrl = document.getElementById('sheetUrl').value;

            if (!sheetUrl) {
                alert('‚ùå Please enter your Google Sheets API URL first');
                return;
            }

            if (users[username] && users[username].password === password && users[username].type === userType) {
                currentUser = users[username];
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('currentSheetUrl').value = sheetUrl;
                
                if (userType === 'staff') {
                    document.getElementById('staffView').style.display = 'block';
                    document.getElementById('staffName').textContent = currentUser.name;
                    document.getElementById('staffId').textContent = currentUser.id;
                    document.getElementById('staffUserName').textContent = currentUser.name;
                    showStaffSection('punch');
                    testConnection();
                } else {
                    document.getElementById('adminView').style.display = 'block';
                    showAdminSection('dashboard');
                    testConnection().then(connected => {
                        if (connected) {
                            loadAdminData();
                            loadAllRecords();
                        }
                    });
                }
                
                document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
            } else {
                alert('‚ùå Invalid login credentials! Please check your username and password.');
            }
        }

        function logout() {
            currentUser = null;
            sheetUrl = '';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('staffView').style.display = 'none';
            document.getElementById('adminView').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showStaffSection(section) {
            document.getElementById('staffPunchSection').style.display = 'none';
            document.getElementById('staffRecordsSection').style.display = 'none';
            
            if (section === 'punch') {
                document.getElementById('staffPunchSection').style.display = 'block';
                updatePunchStatus();
            } else if (section === 'myRecords') {
                document.getElementById('staffRecordsSection').style.display = 'block';
                loadStaffRecords();
            }
        }

        function showAdminSection(section) {
            document.getElementById('adminDashboardSection').style.display = 'none';
            document.getElementById('adminManageSection').style.display = 'none';
            document.getElementById('adminUsersSection').style.display = 'none';
            document.getElementById('adminReportsSection').style.display = 'none';
            document.getElementById('adminSetupSection').style.display = 'none';
            
            if (section === 'dashboard') {
                document.getElementById('adminDashboardSection').style.display = 'block';
            } else if (section === 'manage') {
                document.getElementById('adminManageSection').style.display = 'block';
            } else if (section === 'users') {
                document.getElementById('adminUsersSection').style.display = 'block';
                loadUsersList();
            } else if (section === 'reports') {
                document.getElementById('adminReportsSection').style.display = 'block';
                loadEmployeeDropdown();
            } else if (section === 'setup') {
                document.getElementById('adminSetupSection').style.display = 'block';
            }
        }

        function showMessage(message, elementId, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.className = `status-message status-${type}`;
            }
        }

        function updatePunchStatus() {
            const statusElement = document.getElementById('currentStatus');
            statusElement.textContent = 'Check your records for current status';
            statusElement.style.background = '#e2e8f0';
            statusElement.style.color = '#4a5568';
        }

        function calculateHours(timeIn, timeOut) {
            if (!timeIn || !timeOut || timeIn === '-' || timeOut === '-') return '-';
            
            try {
                const [inHours, inMinutes] = timeIn.split(':').map(Number);
                const [outHours, outMinutes] = timeOut.split(':').map(Number);
                
                const totalMinutes = (outHours * 60 + outMinutes) - (inHours * 60 + inMinutes);
                if (totalMinutes < 0) return '-';
                
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                return `${hours}h ${minutes}m`;
            } catch (e) {
                return '-';
            }
        }

        function copyScript() {
            const textarea = document.getElementById('scriptCode');
            textarea.select();
            document.execCommand('copy');
            alert('‚úÖ Script copied to clipboard! Now paste it in Google Apps Script.');
        }

        function loadEmployeeDropdown() {
            const select = document.getElementById('reportEmployee');
            select.innerHTML = '<option value="all">All Employees</option>';
            
            const staffUsers = Object.values(users).filter(user => user.type === 'staff');
            
            staffUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.id})`;
                select.appendChild(option);
            });
        }

        async function generateReport() {
            const date = document.getElementById('reportDate').value;
            const employeeId = document.getElementById('reportEmployee').value;
            
            let filteredRecords = allRecords;
            
            if (date) {
                filteredRecords = filteredRecords.filter(record => record.Date === date);
            }
            
            if (employeeId !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.EmployeeID === employeeId);
            }
            
            const results = document.getElementById('reportResults');
            if (filteredRecords.length === 0) {
                results.innerHTML = '<div class="status-message status-info">No records found for the selected criteria.</div>';
                return;
            }
            
            let html = `<h3>üìä Report Results (${filteredRecords.length} records)</h3>`;
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #4299e1; color: white;"><th>Date</th><th>Employee</th><th>Time In</th><th>Time Out</th><th>Status</th><th>Hours</th></tr>';
            
            filteredRecords.forEach(record => {
                html += `<tr>
                    <td>${record.Date}</td>
                    <td>${record.EmployeeName}</td>
                    <td>${record.TimeIn || '-'}</td>
                    <td>${record.TimeOut || '-'}</td>
                    <td>${record.Status}</td>
                    <td>${calculateHours(record.TimeIn, record.TimeOut)}</td>
                </tr>`;
            });
            
            html += '</table>';
            results.innerHTML = html;
        }

        function exportToExcel() {
            if (allRecords.length === 0) {
                alert('No data to export');
                return;
            }

            // Create CSV content
            let csvContent = "Date,Employee ID,Employee Name,Time In,Time Out,Status,Hours Worked\n";
            
            allRecords.forEach(record => {
                csvContent += `"${record.Date}","${record.EmployeeID}","${record.EmployeeName}","${record.TimeIn || '-'}","${record.TimeOut || '-'}","${record.Status}","${calculateHours(record.TimeIn, record.TimeOut)}"\n`;
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function exportUsersToExcel() {
            const staffUsers = Object.values(users).filter(user => user.type === 'staff');
            
            // Create CSV content
            let csvContent = "Username,Full Name,Employee ID,Default Password\n";
            
            staffUsers.forEach(user => {
                const username = Object.keys(users).find(key => users[key] === user);
                csvContent += `"${username}","${user.fullName}","${user.id}","${user.password}"\n`;
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `staff_users_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function loadAllData() {
            if (currentUser && currentUser.type === 'admin') {
                loadAdminData();
                loadAllRecords();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sheetUrlParam = urlParams.get('sheetUrl');
            if (sheetUrlParam) {
                document.getElementById('sheetUrl').value = sheetUrlParam;
            }
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>